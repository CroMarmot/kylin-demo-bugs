var gulp=require("gulp"),gutil=require("gulp-util"),replace=require("gulp-replace"),sort=require("gulp-sort"),mdToJson=require("gulp-markdown-to-json"),marked=require("marked"),fs=require("fs-extra"),argv=require("yargs").array("input").argv,path=require("path"),tmpdir=require("os").tmpdir,rootPath=process.cwd(),defaultInputFiles=["./_docs/**/*.md","!./_docs/**/meta.md","!./_docs/index.md","!./_docs/changelog.md","!./_docs/develop.md","!./_docs/data/querystring/*.md","!./_docs/util/extend/*.md","!./_docs/util/log/localLog.md"],defaultOutputPath="./types",defaultOutputFileInc="./types/jsapi.inc.d.ts",defaultOutputFileNoInc="./types/jsapi.d.ts",defaultOutputTestPath="./types/test/",libFileMap={"./lib/alipayjsapi.inc.d.ts":"\nimport * as ap from '../types/entry.inc';\nexport default ap;\n","./lib/alipayjsapi.d.ts":"\nimport * as ap from '../types/entry';\nexport default ap;\n"},inputFiles=argv.input&&argv.input.length>0?argv.input:defaultInputFiles,tempFile="__alipayjsapi_mdtemp.json",_SNIPPETS={},_TYPES={},_TYPES_ApiName={};let latestApi;var renderer=new marked.Renderer,isCallbackTable=!1;function parseOptionTableRowToSnippet(e){let t=e.split("</td>\n<td>");if(4===t.length){var r={extra:"",name:((t=t.map(e=>e.replace(/(<\/td>|\n|<td>)/g,"")))[0]||"").replace(/(^{{{)|(}}}\s*$)/g,"").trim(),originalType:t[1],type:getTsType(t[1]),multiple:/^\d选1$/.test(t[2]),required:/^是|Y$/.test(t[2])?"":/^否|N$/.test(t[2])?"?":`[[[未知${t[2]}]]]`,comment:t[3].replace(/(^{{{)|(}}}\s*$)/g,"")};if(0===latestApi.argsIndex)latestApi.types.args.push(r);else{const e=latestApi.argsIndex-1;latestApi.types.argsExtra[e]=latestApi.types.argsExtra[e]||[],latestApi.types.argsExtra[e].push(r)}}else if(isCallbackTable&&3===t.length){r={extra:"",name:((t=t.map(e=>e.replace(/(<\/td>|\n|<td>)/g,"")))[0]||"").replace(/(^{{{)|(}}}\s*$)/g,"").trim(),originalType:t[1],type:getTsType(t[1]),required:"",comment:t[2].replace(/(^{{{)|(}}}\s*$)/g,"")};if(0===latestApi.argsIndex)latestApi.types.returnArg.push(r);else{const e=latestApi.argsIndex-1;latestApi.types.returnArgExtra[e]=latestApi.types.returnArgExtra[e]||[],latestApi.types.returnArgExtra[e].push(r)}}return""}function getTsType(e){let t;switch(e=e.toLowerCase()){case"string number boolean":t="string|number|boolean";break;case"string number":t="string|number";break;case"string/arraybuffer":t="string|ArrayBuffer";break;case"hex string":case"string":t="string";break;case"object":t="Object";break;case"number":t="number";break;case"array":t="string[]";break;case"boolean":t="boolean";break;case"object/string":t="Object|string";break;case"string array":t="string[]";break;default:console.log("type",e),t="any"}return t}function getApiInfo(e){var t={},r=e.match(/^ap\.(\w+)\((\w+)??((?: \| (\w+))*)(?:(?:, )?(CALLBACK))?\)$/i);return r&&(t={name:r[1],option:r[2],shortcut:(r[3]||"").split("|").slice(1).map(e=>e.trim()),callback:r[5]}),void 0===t.name&&console.log("未识别接口，请手动处理>>>> ",t,e),t}function getCustomType(e,t){return"getAuthCode"===t&&"scopes"===e.name?"'auth_base'|'auth_user'|Array<'auth_base'|'auth_user'>":"setOptionButton"===t&&"onClick"===e.name?"(data: {index: number}) => void":"rpc"===t&&"requestData"===e.name?"Object":"getConfig"===t&&"keys"===e.name?"Array<'mgw'|'did'|'uuid'|string>":"showToast"===t&&"type"===e.name?"'none'|'success'|'fail'|'exception'":/getStorage|removeStorage|setStorage|clearStorage/.test(t)&&"type"===e.name?"'user'|'common'":"chooseImage"===t&&"sourceType"===e.name?"Array<'camera'|'album'|string>":/^(onPageResume|getSessionData|getStorage|onResume)$/.test(t)&&"data"===e.name?"any":/^(alert|confirm|showLoading|showToast)$/.test(t)&&"content"===e.name?"any":e.type}function getExtraArgAtIndex(e,t,r,a,n){var i="",s=0;e.name.replace(/<[^>]+>/g,"").trim();var p=n||!/array/i.test(e.originalType);return e.comment,i+=`${p?"":"Array<"}{\n`,t[r].forEach((e,n)=>{if(!e.ignore)if(/<[^>]+>/.test(e.name)){s++;const n=e.name.replace(/<[^>]+>/g,"").trim();var p=!/array/i.test(e.originalType);e.comment?i+=`        /** ${e.comment.replace(/<[^>]+>/g,"")} */\n        ${n}${a?"?":e.required}: ${p?"":"Array<"}{\n`:i+=`        ${n}${a?"?":e.required}: ${p?"":"Array<"}{\n`,t[r+s].forEach((e,t)=>{i+=e.comment?`          /** ${e.comment.replace(/<[^>]+>/g,"")} */\n          ${e.name}${a?"?":e.required}: ${e.type},`:`        ${e.name}${a?"?":e.required}: ${e.type},`,i+="\n"}),i+=`        }${p?"":">"},\n`}else i+=e.comment?`        /** ${e.comment.replace(/<[^>]+>/g,"")} */\n        ${e.name}${a?"?":e.required}: ${e.type},`:`        ${e.name}${a?"?":e.required}: ${e.type},`,i+="\n"}),{text:i+=`      }${p?"":">"}`,newIndex:r+=s+1}}function formatArgsAll(e,t,r,a,n){let i="",s={},p=0;for(let a=0;a<e.length;a++)if(/<[^>]+>/.test(e[a].name)){let r;if(t[p].filter(e=>e.multiple).length){let i=[];const s=t[p].filter(e=>e.multiple);s.forEach((o,l)=>{s.forEach(e=>{e.ignore=!0}),s[l].ignore=!1,s[l].required="",r=getExtraArgAtIndex(e[a],t,p,n,!0),i.push(r.text)});var o=!/array/i.test(e[a].originalType);r={newIndex:r.newIndex,text:(o?"":"Array<")+i.join(" | ")+(o?"":">")}}else r=getExtraArgAtIndex(e[a],t,p,n);const{newIndex:s,text:l}=r,c=e[a].name.replace(/<[^>]+>/g,"").trim();o=!/array/i.test(e[a].type);e[a].comment?i+=`      /** ${e[a].comment.replace(/<[^>]+>/g,"")} */\n      ${c}${n?"?":e[a].required}: `:i+=`    ${c}${n?"?":e[a].required}: `,i+=l,p=s,e[a].extra=l,i+=",\n"}else{const t=e[a],p=getCustomType(t,r);s[t.name]||(s[t.name]=!0,i+=t.comment?`      /** ${t.comment.replace(/<[^>]+>/g,"")} */\n      ${t.name}${n?"?":t.required}: ${p},`:`      ${t.name}${n?"?":t.required}: ${p},`,a!==e.length-1&&(i+="\n"))}if(p!==t.length)throw new TypeError("extra table not balance");return i}function removeArrayType(e){return/\[\]$/.test(e)?e.replace(/\[\]$/,""):/^Array<.*?>$/.test(e)?e.replace(/^Array</,"").replace(/>$/,""):e}function formatTypeDefinition(e,t){var r=`\n// declare namespace ap {\n\n${Object.keys(e).map(t=>e[t]).filter(e=>!/Sync$/.test(e.apiName)).map(e=>{var r=e.apiName,a=e.returnArg,n=e.isInc;if("boolean"!=typeof n)throw new TypeError("inc not found in types");if(n&&!t)return"";/^(rpc|httpRequest)$/.test(r)&&a.push({name:"[field: string]",type:"any",required:"",comment:"返回任意业务字段"}),a=(a.length,a.concat([{name:"error",type:"number",required:"?",comment:"错误码"},{name:"errorMessage",type:"string",required:"?",comment:"错误信息"}]));var i=e.returnArgExtra,s=a&&a.length?`{ \n${formatArgsAll(a,i,r,!0)}\n    }`:"Object",p=a&&a.length?`{ \n${formatArgsAll(a,i,r,!0,!0)}\n    }`:"Object";p=p.replace("[field: string]?","[field: string]");var o=e.args.concat([{name:"success",type:`(result?: ${s.replace(/^/gm,"  ")}) => void`,comment:"接口调用成功的回调函数",extra:"",required:"?"},{name:"fail",type:`(result?: ${p.replace(/^/gm,"  ")}) => void`,comment:"接口调用失败的回调函数",extra:"",required:"?"},{name:"complete",type:`(result?: ${p.replace(/^/gm,"  ")}) => void`,comment:"接口调用结束的回调函数（调用成功、失败都会执行）",extra:"",required:"?"}]),l=e.argsExtra,c=e.desc.split("\n"),u=e.callback,m=formatArgsAll(o,l,r),g=o.reduce((e,t)=>e&&t.required,!0),d=`    /**\n${c.map(e=>`     * ${e}`).join("\n")}\n${o.length?"     * @param option\n":""}     */ \n    export function ${r}(${o.length?`option: {\n${m}      \n    }`:""}${u?`${m?", ":""}callback?: (result: ${s}) => void`:""}): Promise<${u?s:"any"}>;\n`,y="";o.length&&g&&(y+="\n",y+=`    /**\n${c.map(e=>`     * ${e}`).join("\n")}\n${o.length?"     * @param option\n":""}     */ \n    export function ${r}(${u?`callback?: (result: ${s}) => void`:""}): Promise<${u?s:"any"}>;\n`);var f=[];return e.shortArgKeys.length&&e.shortArgKeys.forEach(e=>{var t=o.find(t=>t.name.replace(/<[^>]+>/g,"").trim()===e);if(!t){if(!(t=o.find(t=>t.name.replace(/<[^>]+>/g,"").trim()===`${e}s`)))return;(t=JSON.parse(JSON.stringify(t))).type=removeArrayType(t.type),t.extra&&(t.extra=removeArrayType(t.extra)),t.name=e,t.required=""}var a=`    /**\n${c.map(e=>`     * ${e}`).join("\n")}\n     */ \n    export function ${r}(${e}: ${t.extra.replace(/^\s{2}/gm,"")||getCustomType(t,r)}${u?`${m?", ":""}callback?: (result: ${s}) => void`:""}): Promise<${u?s:"any"}>;\n`;f.push(a)}),d+(f.length?"\n":"")+f.join("\n")+y}).join("\n")}\n`;return r+="\n    /**\n     * 显示导航栏右上角弹出的下拉菜单。可直接传入一个数组作为 OPTION.items 参数。\n     * @param {string[]} 菜单title数组\n     */ \n    export function showPopMenu(items: Array<string>, callback?: (result: { \n      /** 被点击的菜单项的索引，从0开始 */\n      index: number,\n      /** 错误码 */\n      error?: number,\n      /** 错误信息 */\n      errorMessage?: string,\n    }) => void): Promise<{ \n      /** 被点击的菜单项的索引，从0开始 */\n      index: number,\n      /** 错误码 */\n      error?: number,\n      /** 错误信息 */\n      errorMessage?: string,\n    }>;\n"}renderer.heading=((e,t)=>{1===t?(isCallbackTable=!1,(latestApi=getApiInfo(e)).argsIndex=0,latestApi.suggestion=`${latestApi.name}(${latestApi.option||""})`,latestApi.optionCounter=1,latestApi.body=[],latestApi.snippet=_SNIPPETS[latestApi.suggestion]={docs:""},latestApi.types=_TYPES[latestApi.suggestion]=_TYPES_ApiName[latestApi.name]={apiName:latestApi.name,desc:"",args:[],argsExtra:[],returnArg:[],returnArgExtra:[],shortArgKeys:latestApi.shortcut,callback:!!latestApi.callback,return:"Promise<Object>"}):2===t&&/CALLBACK/.test(e)&&(isCallbackTable=!0,latestApi.argsIndex=0)}),renderer.paragraph=function(e){latestApi.snippet.docs||(latestApi.types.desc=latestApi.snippet.docs=e.replace("<br>","\n"),latestApi.shortcutSnippet&&(latestApi.shortcutSnippet.docs=e.replace("<br>","\n")))},renderer.table=(e=>{latestApi.argsIndex++}),renderer.tablerow=(e=>{parseOptionTableRowToSnippet(e)}),renderer.html=function(e){console.log("html")},renderer.code=function(e,t){if(/^demo/.test(t)&&!/Sync$/.test(latestApi.name)){const t=latestApi.name,r=path.resolve(defaultOutputTestPath,`./${t}.js`);e="import ap from '../../lib/alipayjsapi.inc';"+(e=(e=(e=e.replace(/<(?!script)[^>]+>(.|[\n\r])*?<\/(?!script)[^>]+>/g,"")).replace(/<[^>]+>/g,"")).replace(/ap\.enableDebug.*;/g,"")),fs.outputFileSync(r,e,"utf8")}},marked.setOptions({renderer:renderer,pedantic:!0}),gulp.task("default",function(){gulp.src(inputFiles).pipe(sort()).pipe(gutil.buffer()).pipe(mdToJson(marked,tempFile,function(e,t){if(!e)throw new TypeError("data not found");{const t=e.title.replace(/^ap\./,"").replace(/<[^>]+>inc<\/[^>]+>/,""),r=_TYPES_ApiName[t];if(r)r.isInc=!e.public;else if(!/Deprecated/.test(e.title))throw new TypeError("inc not found")}return e})).pipe(gulp.dest(tmpdir())).on("end",()=>{console.log("end"),fs.outputFileSync(defaultOutputFileInc,formatTypeDefinition(_TYPES,!0)),fs.outputFileSync(defaultOutputFileNoInc,formatTypeDefinition(_TYPES,!1)),Object.keys(libFileMap).forEach(e=>{const t=libFileMap[e];fs.outputFileSync(e,t)})})});