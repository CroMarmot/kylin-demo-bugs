var t=require("babel-types"),template=require("babel-template"),helperObjectFactory=template("\nfunction ID() {\n  var arg = arguments;\n  var ret = {};\n  for(var i=0;i<arg.length;i+=2) {\n    ret[ arg[i] ] = arg[i+1];\n  }\n  return ret;\n}\n"),helperDeleteFactory=template("\nfunction ID(obj, prop) {\n  delete obj[prop];\n}\n");function extractDeleteMemberExpression(e,n){const r=Object.create(null);e.traverse({UnaryExpression:function(e,n){const o=getTopIIFEPath(e);if(o&&o.scope&&"delete"===e.node.operator&&t.isMemberExpression(e.node.argument,{computed:!1})&&t.isIdentifier(e.node.argument.property)){const n=getHelperFuncFromScope(o,r,helperDeleteFactory,"FUNC_delete_factory");e.replaceWith(t.callExpression(n,[e.node.argument.object,t.StringLiteral(e.node.argument.property.name)]))}}},n)}function getHelperFuncFromScope(e,t,n,r){const o=e.scope,i=o.uid;if(!t[i]){const a=o.generateUidIdentifier(r);t[i]=a,e.unshiftContainer("body",n({ID:a}))}return t[i]}function replaceObjectToFunction(e,n){const r=Object.create(null);e.traverse({ObjectExpression:function(e,n){const o=getTopIIFEPath(e);if(!o||!o.scope)return;if(t.isObjectProperty(e.parent))return;if(e.node.properties.filter(e=>t.isSpreadProperty(e)||!t.isIdentifier(e.key)||t.isObjectProperty(e,{computed:!0})||t.isObjectMethod(e,{computed:!0})||t.isObjectProperty(e)&&t.isObjectExpression(e.value)).length)return;if(e.node.properties.filter(e=>e.key.name.length>=4).length<1)return;const i=getHelperFuncFromScope(o,r,helperObjectFactory,"FUNC_object_factory"),a=[];e.node.properties.forEach(e=>{t.isObjectProperty(e)?(a.push(t.stringLiteral(e.key.name)),a.push(e.value)):t.isObjectMethod(e)&&(a.push(t.stringLiteral(e.key.name)),a.push(t.functionExpression(null,e.params,e.body,e.generator,e.async)))}),e.replaceWith(t.callExpression(i,a))}},n)}function hoistObjectMethod(e,n){function r(e){for(var n=e;n;){if(t.isBlockStatement(n.node)&&t.isFunction(n.parent)){!0;break}n=n.parentPath}return n}function o(e){for(var n=e,r=[];n&&(t.isObjectProperty(n.node)||t.isObjectMethod(n.node));)r.unshift(n.node.key.name),n=n.parentPath.parentPath;return r.unshift("Func"),r.join("_")}e.traverse({ObjectExpression:function(e,n){e.traverse({ObjectProperty:function(e,n){if(t.isIdentifier(e.node.key)&&t.isFunctionExpression(e.node.value)&&!t.isArrowFunctionExpression(e.node.value)){var i=e.node.value,a=e.scope.generateUidIdentifier(o(e));r(e).pushContainer("body",t.functionDeclaration(a,i.params,i.body,i.generator,i.async)),e.replaceWith(t.objectProperty(e.node.key,a,e.node.computed,!1,e.node.decorators))}},ObjectMethod:function(e,n){if(t.isIdentifier(e.node.key)){var i=e.scope.generateUidIdentifier(o(e)),a=e.node;r(e).pushContainer("body",t.functionDeclaration(i,a.params,a.body,a.generator,a.async)),e.replaceWith(t.objectProperty(e.node.key,i,e.node.computed,!1,e.node.decorators))}}},n)}},n)}function replaceMemberExpressionAndStringLiteral(e,t){replaceCommonIdAndLiteral(e,insertStringDeclarator(e,foundCommonIdAndLiteral(e),t))}function replaceCommonIdAndLiteral(e,n){function r(e,t){return n[`name:${e}_scope:${t}`]}e.traverse({MemberExpression:function(e){if(t.isMemberExpression(e.node,{computed:!1})&&t.isIdentifier(e.node.property)){var n=e.node.property.name,o=getTopIIFEScope(e);if(o){var i=r(n,o.uid);i&&e.replaceWith(t.memberExpression(e.node.object,i.uid,!0))}}},StringLiteral:function(e){if(t.isStringLiteral(e.node)){var n=e.node.value,o=getTopIIFEScope(e);if(o){var i=r(n,o.uid);i&&(t.isVariableDeclarator(e.parent)?t.isIdentifier(e.parent.id)&&(e.parent.id.name===i.uid.name||e.replaceWith(i.uid)):e.replaceWith(i.uid))}}}})}function insertStringDeclarator(e,n,r){function o(e,t){return n[e].count>n[t].count?-1:n[e].count<n[t].count?1:0}var i=Object.create(null);return e.traverse({BlockStatement:function(e,r){if(!t.isFunction(e.parent))return;var a=e.parentPath.scope,c=a.uid,p=Object.keys(n).filter(e=>n[e].scopeId===c).sort(o).map(e=>n[e]);if(p.length){var s=p.map(e=>{var n=e.name,r=e.count;if(n.length*(r-1)>=6&&n.length>=3){var o=a.generateUidIdentifier("STR_"+n),p=t.variableDeclarator(o,t.stringLiteral(n));return function(e,t,n){var r=`name:${e}_scope:${t}`;i[r]=i[r]||{name:e,scopeId:t,uid:n}}(n,c,o),p.trailingComments=[{type:"CommentBlock",value:" count: "+r+" "}],p}}).filter(Boolean);s.length&&e.unshiftContainer("body",t.variableDeclaration("const",s))}}},r),i}function getTopIIFEPath(e){for(var n,r=e;r;)t.isBlockStatement(r.node)&&t.isFunction(r.parent)&&(n=r),r=r.parentPath;return n}function getTopIIFEScope(e){var t=getTopIIFEPath(e);return t&&t.scope}function foundCommonIdAndLiteral(e){var n=Object.create(null);function r(e,t){var r=`name:${e}_scope:${t}`;n[r]=n[r]||{count:0,name:e,scopeId:t},n[r].count++}return e.traverse({MemberExpression:function(e,n){if(t.isMemberExpression(e.node,{computed:!1})&&t.isIdentifier(e.node.property)){var o=e.node.property.name,i=getTopIIFEScope(e);i&&r(o,i.uid)}},StringLiteral:function(e,n){if(t.isStringLiteral(e.node)){var o=e.node.value,i=getTopIIFEScope(e);i&&r(o,i.uid)}}}),n}module.exports=function(e){e.messages,e.template,e.types;return{pre:function(e){},visitor:{Program:{exit(e,t){extractDeleteMemberExpression(e,t),replaceMemberExpressionAndStringLiteral(e,t)}}}}};