"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LunaInjectMockPlugin=LunaInjectMockPlugin,exports.default=webpackMockConfig;var _path=require("path"),_path2=_interopRequireDefault(_path),_ConcatSource=require("webpack-core/lib/ConcatSource"),_ConcatSource2=_interopRequireDefault(_ConcatSource),_index=require("../../utils/index"),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_fs=require("fs"),_fs2=_interopRequireDefault(_fs);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const mockEntry="__lunaMock";function getLunaMock(){let e="";const t=require.resolve("@alipay/luna-mock/dist/index.js");return _fs2.default.existsSync(t)?e=_fs2.default.readFileSync(t,{encoding:"utf8"}):_index.hint.error("[Mock]",`mock依赖库 [${_chalk2.default.red("@alipay/luna-mock/dist/index.js")}] 未找到`),e}function LunaInjectMockPlugin(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.options=e}function webpackMockConfig(e,t,n){if(!e.mock)return n;const o=!0===e.mock?t.options.defaultLunaMockConfigPath:e.mock,c=_path2.default.resolve(e.cwd,o);return _fs2.default.existsSync(c)?n.entry[mockEntry]=[c]:_index.hint.error("[Mock]",`${_chalk2.default.red("没有找到")} [${_chalk2.default.red(c)}] ${_chalk2.default.red("，将使用默认配置，无法使用自定义mock功能，")}\n请参考${_chalk2.default.yellow("http://gitlab.alipay-inc.com/luna/luna-mock/blob/master/demo/mock.config.js")}`),n.plugins.push(new LunaInjectMockPlugin),n}LunaInjectMockPlugin.prototype.apply=function(e){e.plugin("compilation",e=>{e.plugin("optimize-chunk-assets",(t,n)=>{const o=t.filter(e=>e.name===mockEntry)[0];if(!o)return void n();const c=getLunaMock(),a=e.assets[o.files[0]]||"";t.forEach(t=>{t.name!==mockEntry&&t.files.filter(e=>/.(js)$/.test(e)).forEach(t=>{e.assets[t]=new _ConcatSource2.default(a,"\n",c,"\n",e.assets[t])})}),n()})})};