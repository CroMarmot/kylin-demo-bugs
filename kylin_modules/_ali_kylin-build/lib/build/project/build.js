"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=build;var _entry=require("./entry"),_webpack=require("webpack"),_webpack2=_interopRequireDefault(_webpack),_index=require("../../utils/index.js"),_path=require("path"),_path2=_interopRequireDefault(_path),_kylinI18NLoaderPlugin=require("../plugin/kylinI18NLoaderPlugin"),_kylinI18NLoaderPlugin2=_interopRequireDefault(_kylinI18NLoaderPlugin),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_index2=require("../plugin-loader/index.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function*build(e,r){const t=r.options,i=t.nebulaTargetArr,o=t.nebulaTarget;if(t.originalNebulaTarget)for(let t of i)yield buildForTarget(e,r,{target:t,assetsRoot:_path2.default.join(r.output,t)});else yield buildForTarget(e,r,{target:o,assetsRoot:r.output})}function*buildForTarget(e,r){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};var i=t.target;const o=void 0===i?"common":i,n=t.assetsRoot;r.options.nebulaTarget=o,console.log(),(0,_index.hint)("[Build]",`NODE_ENV = ${process.env.NODE_ENV}`),(0,_index.hint)("[Build]",`nebulaTarget = ${o}`),(0,_index.hint)("[Build]",`assetsRoot = ${n}`);let a=yield(e.prod?require("./webpack.project.prod.conf"):require("./webpack.project.dev.conf"))(e,r,{assetsRoot:n});a.entry=(0,_entry.getEntry)(e,r),(0,_index2.hasPluginId)(e,r,"@ali/kylin-plugin-i18n")||(a=(0,_kylinI18NLoaderPlugin2.default)(e,r,a));(0,_entry.getExternalEntry)(e,r);try{a=yield(0,_index2.applyPluginForWebpack)(a,r)}catch(e){throw _index.hint.error("[Config]","applying plugin for webpack phase error"),_index.hint.error("[Config]",e),e}const u=_path2.default.resolve(e.cwd,r.options.defaultWebpackConfigFactoryPath);try{if(_fs2.default.existsSync(u)){const e=require(u);"function"==typeof e?a=e(a)||a:_index.hint.error("[Config]",`webpack.config is not function with path [${u}]`)}}catch(e){_index.hint.error("[Config]",`webpack.config process error with path [${u}]`),_index.hint.error("[Config]",e)}const l=(0,_webpack2.default)(a);if(!e.watch)return new Promise((e,r)=>{l.run((t,i)=>{t?r(t.stack||t):i.hasErrors()?r(i.toJson().errors.join("\n")):(s(i),e())})});function s(r){process.stdout.write(r.toString({colors:!0,modules:!!e.verbose,children:!!e.verbose,chunks:!!e.verbose,chunkModules:!!e.verbose})+"\n")}l.watch({aggregateTimeout:300,poll:!0},(e,r)=>{e||r.hasErrors(),s(r)})}module.exports=exports.default;