"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=server;var _index=require("../../utils/index"),_entry=require("./entry"),_express=require("express"),_express2=_interopRequireDefault(_express),_https=require("https"),_https2=_interopRequireDefault(_https),_webpack=require("webpack"),_webpack2=_interopRequireDefault(_webpack),_path=require("path"),_path2=_interopRequireDefault(_path),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_urllib=require("urllib"),_urllib2=_interopRequireDefault(_urllib),_os=require("os"),_os2=_interopRequireDefault(_os),_co=require("co"),_co2=_interopRequireDefault(_co),_opn=require("opn"),_opn2=_interopRequireDefault(_opn),_lsof=require("lsof"),_lsof2=_interopRequireDefault(_lsof),_lunaInjectMock=require("../plugin/lunaInjectMock"),_lunaInjectMock2=_interopRequireDefault(_lunaInjectMock),_kylinI18NLoaderPlugin=require("../plugin/kylinI18NLoaderPlugin"),_kylinI18NLoaderPlugin2=_interopRequireDefault(_kylinI18NLoaderPlugin),_index2=require("../plugin-loader/index.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function*server(e,t){const n=t.options,r=n.nebulaTargetArr;n.nebulaTarget,n.originalNebulaTarget;let i=r[0]||"common";r.length>1&&_index.hint.warn("[Warn]",`--server does not support multiple "nebulaTarget", will treat as "${i}"`),yield startServer(e,t,{target:i})}function*startServer(e,t,n){const r=n.target;t.options.nebulaTarget=r,console.log(),(0,_index.hint)("[Server]",`NODE_ENV = ${process.env.NODE_ENV}`),(0,_index.hint)("[Server]",`nebulaTarget = ${r}`),(0,_index.hint)("[Server]",`port = ${t.devPort}`);const i=yield(e.prod?require("./webpack.project.prod.conf"):require("./webpack.project.dev.conf"))(e,t,{assetsRoot:"/"});i.entry=(0,_entry.getEntry)(e,t),i.watch=!0,e.hot&&Object.keys(i.entry).forEach(function(e){i.entry[e]=[_path2.default.resolve(__dirname,"./server-client")].concat(i.entry[e])});let o=(0,_express2.default)();yield appListen(e,t,{app:o=injectHttps(e,t,o=yield useMiddleware(e,t,{webpackConfig:i,webpackWorkerConfig:null})(o)),port:t.devPort,address:"0.0.0.0"}),_index.hint.success("\n[Success]",`listen at ${t.devPort}`);const a=yield getHpmDomain(e,t);_index.hint.success("\n[Success]",`hpm domain: ${a}:${t.devPort}`),yield tryDevOpenUrl(e,t,{bindDomain:a})}function*appListen(e,t,n){let r=n.app,i=n.port;var o=n.address;let a=void 0===o?"0.0.0.0":o;return new Promise(function(e,t){r.listen(i,a,function(n){n?t(n):e()})})}function getEntryUrl(e,t,n){let r,i=n.entry,o=n.domain;if(r=!0===i?Object.keys(t.pages||{})[0]:t.pages[i]?i:void 0)return`${o}:${t.devPort}/${r}.html`;void 0===i||_index.hint.error("[Error]",!0===i?"kylinApp.pages is empty":`specific entry [${i}] not found in kylinApp.pages`)}function*tryDevOpenUrl(e,t,n){let r=n.bindDomain;const i=getEntryUrl(e,t,{entry:e.open,domain:r}),o=getEntryUrl(e,t,{entry:e.qrcode,domain:r}),a=getEntryUrl(e,t,{entry:e.sim,domain:r});i&&(_index.hint.success("[Tool]",`opening [${i}]`),(0,_opn2.default)(i)),o&&(e.hpmDomain?(_index.hint.success("[Tool]",`opening [${o}] for qrcode`),(0,_opn2.default)(`http://qr.liantu.com/api.php?text=${encodeURIComponent(o)}`)):_index.hint.error("[Error]","--qrcode should be used with --domain")),a&&(yield openInHpmSimStart(e,t,{simUrl:a}))}function*openInHpmSimStart(e,t,n){const r=`hpm sim start ${n.simUrl}`;(0,_index.hint)(`[Hpm] exec '${r}'`);const i=yield(0,_index.exec)(r,{slient:!0});console.log(i.stdout)}function injectHttps(e,t,n){return t.useHttps?_https2.default.createServer({key:_fs2.default.readFileSync(_path2.default.resolve(__dirname,"../cert/server.key")),cert:_fs2.default.readFileSync(_path2.default.resolve(__dirname,"../cert/server.crt"))},n):n}function getLocalIP(){let e=999999;const t=[];let n;const r=_os2.default.networkInterfaces();for(let e in r){let n=r[e];for(;n.length;){let e=n.pop();"IPv4"===e.family&&"127.0.0.1"!=e.address&&t.push(e.address)}}return t.forEach(function(t){const r=parseInt(t);r-10<e&&(n=t,e=r-10)}),n}function*getHpmDomain(e,t){if(e.hpmDomain){const e=getLocalIP();if(e)try{const n=yield _urllib2.default.request(`http://nodejs.inc.alipay.net:4567/getDomain?ip=${e}&type=alipay`,{method:"GET",timeout:1e4,dataType:"json"});if(n.status+""=="200"&&n.data.domain)return(t.useHttps?"https://":"http://")+n.data.domain}catch(e){}}return t.useHttps?"https://debug127000000001.local.alipay.net":"http://localhost"}function useMiddleware(e,t,n){return function*(r){r.use("/",function(e,t,n){(0,_index.hint)("[Server]",`${e.get("Host")}${e.url}`),n()});let i=n.webpackConfig;n.webpackWorkerConfig;(0,_index2.hasPluginId)(e,t,"@ali/kylin-plugin-i18n")||(i=(0,_kylinI18NLoaderPlugin2.default)(e,t,i)),(0,_index2.hasPluginId)(e,t,"@ali/kylin-plugin-mock")||(i=(0,_lunaInjectMock2.default)(e,t,i));try{i=yield(0,_index2.applyPluginForWebpack)(i,t)}catch(e){throw _index.hint.error("[Config]","applying plugin for webpack phase error"),_index.hint.error("[Config]",e),e}const o=_path2.default.resolve(e.cwd,t.options.defaultWebpackConfigFactoryPath);try{if(_fs2.default.existsSync(o)){const e=require(o);"function"==typeof e?i=e(i)||i:_index.hint.error("[Config]",`webpack.config is not function with path [${o}]`)}}catch(e){_index.hint.error("[Config]",`webpack.config process error with path [${o}]`),_index.hint.error("[Config]",e)}(0,_index2.applyPluginForExpress)(r,t);const a=(0,_webpack2.default)(i),l=require("webpack-dev-middleware")(a,{publicPath:"/",noInfo:!1,watchOptions:{aggregateTimeout:300,poll:!0},stats:{colors:!0,modules:!!e.verbose,children:!!e.verbose,chunks:!!e.verbose,chunkModules:!!e.verbose}}),s=require("webpack-hot-middleware")(a);return t.options.enableRefresh&&a.plugin("compilation",function(e){e.plugin("html-webpack-plugin-after-emit",function(e,t){s.publish({action:"reload"}),(0,_index.hint)("[Hot]","reload emit"),t()}),e.plugin("html-webpack-plugin-alter-chunks",function(e,t){return s.publish({action:"reload"}),(0,_index.hint)("[Hot]","reload chunks"),e})}),r.use(require("connect-history-api-fallback")()),r.use(l),r.use(s),r}}module.exports=exports.default;