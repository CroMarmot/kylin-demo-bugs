"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=init;var _utils=require("../../utils"),_kylinOptions=require("../utils/kylinOptions"),_kylinOptions2=_interopRequireDefault(_kylinOptions),_utils2=require("../utils"),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_path=require("path"),_path2=_interopRequireDefault(_path),_fs=require("fs"),_fs2=_interopRequireDefault(_fs);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function*init(e){e.cwd;e.dev&&(_utils.hint.warn("[Dev]",'--dev is Deprecated, please use "--server --no-prod --hot --no-compress" instead of it'),console.log(),e.server=!0,e.prod=!1,e.hot=!0,e.compress=!1),e.sourcemap=(0,_utils2.determineSourcemapType)(e.sourcemap,e.prod),process.env.NODE_ENV="test"===process.env.NODE_ENV?process.env.NODE_ENV:e.prod?"production":"development";let t=(0,_utils2.determineKylinConfig)(e,"kylinApp");if(t=preprocessKylinAppConfig(e,t),e.https&&!e.server&&(e.https=!1,_utils.hint.warn("[Server]",`--https only work with ${_chalk2.default.yellow("--server")}`)),e.https&&!t.useHttps&&(t.useHttps=!0,_utils.hint.warn("[Server]",`--https will force ${_chalk2.default.yellow("kylinApp.useHttps=true")}`)),!e.hot||e.server&&!e.prod||(e.hot=!1,_utils.hint.warn("[Warn]","--hot should be used with --server && --no-prod")),e.hot&&(t.options.enableRefresh?_utils.hint.warn("[Hot]",`文件变更会触发${_chalk2.default.yellow("强制刷新")} (kylinApp.options.enableRefresh=true) `):_utils.hint.warn("[Hot]",`文件变更会触发${_chalk2.default.yellow("热替换")} (kylinApp.options.enableRefresh=false) `)),e.qrcode&&!e.hpmDomain&&(e.hpmDomain=!0,_utils.hint.warn("[Warn]","--qrcode will force --hpm-domain")),e.sim&&!e.hpmDomain&&(e.hpmDomain=!0,_utils.hint.warn("[Warn]","--sim will force --hpm-domain")),_fs2.default.existsSync(_path2.default.resolve(e.cwd,t.options.defaultWebpackConfigFactoryPath))&&_utils.hint.success("[Config]",`webpack.config Using [${_chalk2.default.yellow(t.options.defaultWebpackConfigFactoryPath)}]`),(0,require("../plugin-loader/index.js").loadPlugin)(e,t),e.server)yield require("./server.js")(e,t);else{try{yield require("./build.js")(e,t)}catch(t){yield require("../log/index.js")(e,!1,{type:"project"}),console.error(t),process.exit(1)}yield require("../log/index.js")(e,!0,{type:"project"})}}function preprocessKylinAppConfig(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.output||(t.output="dist"),t.pages=t.pages||{},t.devPort=process.env.PORT||t.devPort||8090,t.options=(0,_kylinOptions2.default)(t.options),t.dirAlias=t.dirAlias||{},Object.keys(t.dirAlias).forEach(i=>{t.dirAlias[i]=_path2.default.join(e.cwd,t.dirAlias[i])}),t}module.exports=exports.default;