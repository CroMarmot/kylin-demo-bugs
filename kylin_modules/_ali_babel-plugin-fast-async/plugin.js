"use strict";var hoistHelper=require("./hoist.js"),hoistFunction=hoistHelper.hoistFunction;module.exports=function(e){var n=console.log.bind(console),t=require("nodent-compiler"),o=null,i={},r=!1,s={log:n};function a(n,t,o,i){var r=n+"="+t.toString().replace(/[\s]+/g," ")+";\n";o.parser.ranges=!1,o.parser.locations=!1;var s=e.transform(r).ast.program.body[0];return s=JSON.parse(JSON.stringify(s,function(e,n){return"start"===e||"end"===e?void 0:n}))}var u={SwitchStatement:function(e,n){if(n.opts=n.opts||{},!1!==n.opts.noSwitch)throw e.buildCodeFrameError("switch-case statement is not avaliable in async for current compiler")}};return{manipulateOptions:function(e,n){n.plugins.push("asyncFunctions")},visitor:{Program:{enter:function(e,n){r=!1},exit:function(n,u){if(r){u.opts=u.opts||{};var c=u.opts.env||{};Object.keys(s).forEach(function(e){e in c||(c[e]=s[e])}),o=new t(c),i={},Object.keys(t.initialCodeGenOpts).forEach(function(e){i[e]=t.initialCodeGenOpts[e]}),i.promises=!0,i.babelTree=!0,i.parser={noNodentExtensions:!0};var p=u.opts.compiler||{};u.opts.spec&&(p.promises=!0,p.wrapAwait=!0,p.noRuntime=!0),p&&"object"==typeof p&&Object.keys(p).forEach(function(e){i[e]=p[e]});var l,d={origCode:u.file.code,filename:"",ast:n.node};if(o.asynchronize(d,void 0,i,o.log),!i.noRuntime)if(l=i.generators?a("Function.prototype.$asyncspawn",require("nodent-runtime").$asyncspawn,i):a("Function.prototype.$asyncbind",require("nodent-runtime").$asyncbind,i),u.opts.useRuntimeModule)u.addImport(!0===u.opts.useRuntimeModule?"nodent-runtime":u.opts.useRuntimeModule,"default");else if(u.opts.runtimePattern)if("directive"===u.opts.runtimePattern)for(var f=!1,m=0;m<n.node.directives.length;m++)"use runtime-nodent"===n.node.directives[m].value.value&&(f||(n.unshiftContainer("body",l),f=!0),n.node.directives.splice(m,1));else{var v=new RegExp(u.opts.runtimePattern),h=u.file.parserOpts;(h.filename||h.sourceFileName).match(v)&&n.unshiftContainer("body",l)}else n.unshiftContainer("body",l);u.opts.hoistFuns&&hoistFunction(n,e)}}},AwaitExpression:function(e,n){r=!0},Function:function(e,n){e.node.async&&(r=!0,e.traverse(u,n))}}}};