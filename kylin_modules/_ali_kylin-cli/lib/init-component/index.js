"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e};exports.default=initComponent;var _chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_ora=require("ora"),_ora2=_interopRequireDefault(_ora),_userHome=require("user-home"),_userHome2=_interopRequireDefault(_userHome),_path=require("path"),_path2=_interopRequireDefault(_path),_utils=require("../utils"),_rimraf=require("rimraf"),_rimraf2=_interopRequireDefault(_rimraf),_fs=require("fs"),_fs2=_interopRequireDefault(_fs);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function*getOutputDir(e,t){t.componentName;let r=t.componentNameDash;t.componentNameCamel;const o=`${e.cwd}/package.json`;if(_fs2.default.existsSync(o)){const t=require(o);if(t&&t.kylinApp){const o=JSON.parse(JSON.stringify(t.kylinApp.pages||{})),n=Object.keys(o).map(e=>{const t=o[e];return t.pageName=e,t}).filter(e=>!!e).map(e=>{const t=_path2.default.dirname(e.entry),o=_path2.default.join(t,`./components/${r}.vue`);return{name:`${e.pageName} -- (${o})`,short:o,value:o}});if(n.length>0){const t=n,o=yield(0,_utils.question)([{name:"outputPath",type:"list",message:`将在以下路径生成'${r}'组件模板\n`,choices:t}]);return{outputPath:(0,_utils.getOutputAbsDir)(e,o.outputPath),hasPackageJson:!0}}}}const n=yield(0,_utils.question)([{name:"outputPath",type:"input",message:`无package.json或无有效page entry,\n将在以下路径生成'${r}'组件模板\n`,default:`${e.cwd}/${r}.vue`}]);return{outputPath:(0,_utils.getOutputAbsDir)(e,n.outputPath),hasPackageJson:!1}}function*initComponent(e){e.templatePath=e.t=e.t||"kylin_templates";const t=e.args;e.cwd;let r,o;if(0===t.length)throw new Error("no args");1===t.length?(o=t[0],r="component-template"):(o=t[1],r=t[0]);const n=(0,_utils.parseNameDash)(o),a=(0,_utils.parseNameCamel)(o,!0);var i=yield getOutputDir(e,{componentName:o,componentNameDash:n,componentNameCamel:a});const s=i.outputPath,l=(i.hasPackageJson,getFullGitReps({template:r,program:e})),u=getTempPath(_extends({},l,{program:e})),p=getRepo(_extends({},l,{tmp:u,program:e}));_utils.hint.warn("[Info] Mode:","init-component"),(0,_utils.hint)("[Info] Template:",r),(0,_utils.hint)("[Info] Repo:",p),(0,_utils.hint)("[Info] Tmp:",u),(0,_utils.hint)("[Info] OutputPath:",s);try{if(e.t)yield(0,_utils.gitlabCloneForLocal)({repo:p,tmp:u,program:e,template:r}),_utils.hint.success("[Copy]");else{const t=yield gitlabClone({repo:p,tmp:u,program:e,template:r});_utils.hint.success("[Clone]"),console.log(t)}}catch(e){return _utils.hint.error("[Fail] git clone to tmp directory"),void console.error(e)}try{(0,_utils.copyAndReplaceForFile)(`${u}/index.vue`,s,{componentName:a}),_utils.hint.success("[Done]")}catch(e){_utils.hint.error("[Fail] copy template files to dest"),console.error(e)}}function getFullGitReps(e){let t=e.template;return t.indexOf("/")>-1?{host:"gitlab.alipay-inc.com",template:t}:{host:"gitlab.alipay-inc.com",template:`kylin-templates/${t}`}}function getTempPath(e){e.program;let t=e.template;const r=_path2.default.join(_userHome2.default,".kylin-templates",t.replace(/\//g,"-"));return _rimraf2.default.sync(r),r}function getRepo(e){e.program;return`git@${e.host}:${e.template}.git`}function*gitlabClone(e){let t=e.repo,r=e.tmp;e.program;const o=yield(0,_utils.exec)(`git clone --progress ${t} ${r}`,{slient:!0});if(!_fs2.default.existsSync(r))throw new Error(`destination "${r}" not found`);return o.stderr}module.exports=exports.default;