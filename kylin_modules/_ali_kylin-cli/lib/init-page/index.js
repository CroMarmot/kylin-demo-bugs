"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var a=arguments[e];for(var i in a)Object.prototype.hasOwnProperty.call(a,i)&&(t[i]=a[i])}return t};exports.default=initPage;var _chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_ora=require("ora"),_ora2=_interopRequireDefault(_ora),_userHome=require("user-home"),_userHome2=_interopRequireDefault(_userHome),_path=require("path"),_path2=_interopRequireDefault(_path),_utils=require("../utils"),_rimraf=require("rimraf"),_rimraf2=_interopRequireDefault(_rimraf),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_constant=require("../utils/constant");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function*editPackageJsonPages(t,e){let a=e.pageNameMap,i=e.outputDir,l=e.layoutFile,n=e.configLayout;const o=`${t.cwd}${_path2.default.sep}package.json`,r=require(o);if(r&&r.kylinApp){const e=r.kylinApp.pages=r.kylinApp.pages||{};let s=_path2.default.relative(t.cwd,`${i}${_path2.default.sep}index.js`),u=n?_path2.default.relative(t.cwd,l):void 0;_utils.isWin&&(s=s.replace(/\\/g,"/"),u=u.replace(/\\/g,"/")),e[a.package_entry]=n?{entry:_path2.default.isAbsolute(s)?s:`./${s}`,template:_path2.default.isAbsolute(u)?u:`./${u}`}:{entry:_path2.default.isAbsolute(s)?s:`./${s}`},_fs2.default.writeFileSync(o,JSON.stringify(r,void 0,2),"utf-8")}}function*getOutputDir(t,e){let a=e.pageNameMap,i=e.configLayout;const l=`${t.cwd}${_path2.default.sep}package.json`;if(_fs2.default.existsSync(l)){const e=require(l);if(e&&e.kylinApp){const l=e.kylinApp.pages||{};if(0===Object.keys(l).filter(t=>t===a.dash||t===a.camel||t===a.origin).length){let e=[{name:"outputDir",type:"input",message:`将在以下目录生成'${a.path}'页面模板\n`,default:`${t.cwd}${_path2.default.sep}src${_path2.default.sep}pages${_path2.default.sep}${a.path}/`}];i&&(e=e.concat([{name:"layoutFile",type:"input",message:`将在以下路径生成'${a.path}.html'模板文件\n`,default:`${t.cwd}${_path2.default.sep}src${_path2.default.sep}layout${_path2.default.sep}${a.path}.html`},{name:"layoutTitle",type:"input",message:"请输入模板的默认'title'\n",default:`${a.title}`}]));const l=yield(0,_utils.question)(e);return{outputDir:(0,_utils.getOutputAbsDir)(t,l.outputDir),layoutFile:l.layoutFile?(0,_utils.getOutputAbsDir)(t,l.layoutFile):void 0,layoutTitle:l.layoutTitle,hasPackageJson:!0}}{const t=`'${a.origin}'在kylinApp.pages中已存在重名页面配置`;throw _utils.hint.error("[package.json]",t),new Error(t)}}}const n=yield(0,_utils.question)([{name:"outputDir",type:"input",message:`无package.json或无kylinApp字段,\n将在以下目录生成'${a.path}'页面模板\n`,default:`${t.cwd}${_path2.default.sep}${a.path}${_path2.default.sep}`}]);return{outputDir:(0,_utils.getOutputAbsDir)(t,n.outputDir),hasPackageJson:!1}}function getPageNameByType(t,e){switch(e){case _constant.PAGE_NAME_TYPE.CAMEL:return(0,_utils.parseNameCamel)(t,!0);case _constant.PAGE_NAME_TYPE.DASH:return(0,_utils.parseNameDash)(t);case _constant.PAGE_NAME_TYPE.ORIGIN:return t;default:throw new Error("unknown type for pageName")}}function*initPage(t){t.templatePath=t.t=t.t||"kylin_templates";const e=t.args;t.cwd;let a,i;if(0===e.length)throw new Error("no args");1===e.length?(i=e[0],a="page-template"):(i=e[1],a=e[0]);const l=!!t.t;const n={origin:_constant.PAGE_NAME_TYPE.ORIGIN,camel:_constant.PAGE_NAME_TYPE.CAMEL,dash:_constant.PAGE_NAME_TYPE.DASH,path:_constant.PAGE_NAME_TYPE.DASH,title:_constant.PAGE_NAME_TYPE.CAMEL,package_entry:_constant.PAGE_NAME_TYPE.DASH,template:_constant.PAGE_NAME_TYPE.CAMEL,template_layout:_constant.PAGE_NAME_TYPE.CAMEL};const o=Object.keys(n).reduce((t,e)=>(t[e]=getPageNameByType(i,n[e]),t),{});var r=yield getOutputDir(t,{pageNameMap:o,configLayout:l});const s=r.outputDir,u=r.layoutFile,p=r.layoutTitle,c=r.hasPackageJson,_=getFullGitReps({template:a,program:t}),f=getTempPath(_extends({},_,{program:t})),g=getRepo(_extends({},_,{tmp:f,program:t}));_utils.hint.warn("[Info] Mode:","init-page"),(0,_utils.hint)("[Info] Template:",a),(0,_utils.hint)("[Info] Repo:",g),(0,_utils.hint)("[Info] Tmp:",f),(0,_utils.hint)("[Info] OutputDir:",s);try{if(t.t)yield(0,_utils.gitlabCloneForLocal)({repo:g,tmp:f,program:t,template:a}),_utils.hint.success("[Copy]");else{const e=yield gitlabClone({repo:g,tmp:f,program:t,template:a});_utils.hint.success("[Clone]"),console.log(e)}}catch(t){return _utils.hint.error("[Fail] git clone to tmp directory"),void console.error(t)}try{(0,_utils.copyAndReplace)(f,s,{pageName:o.template,configLayout:l},["layout.html"]),l&&(0,_utils.copyAndReplaceForFile)(`${f}/layout.html`,u,{title:p,pageName:o.template_layout}),c&&(yield editPackageJsonPages(t,{pageNameMap:o,outputDir:s,layoutFile:u,configLayout:l})),_utils.hint.success("[Done]")}catch(t){_utils.hint.error("[Fail] copy template files to dest"),console.error(t)}}function getFullGitReps(t){let e=t.template;return e.indexOf("/")>-1?{host:"gitlab.alipay-inc.com",template:e}:{host:"gitlab.alipay-inc.com",template:`kylin-templates/${e}`}}function getTempPath(t){t.program;let e=t.template;const a=_path2.default.join(_userHome2.default,".kylin-templates",e.replace(/\//g,"-"));return _rimraf2.default.sync(a),a}function getRepo(t){t.program;return`git@${t.host}:${t.template}.git`}function*gitlabClone(t){let e=t.repo,a=t.tmp;t.program;const i=yield(0,_utils.exec)(`git clone --progress ${e} -b master ${a}`,{slient:!0});if(!_fs2.default.existsSync(a))throw new Error(`destination "${a}" not found`);return i.stderr}module.exports=exports.default;